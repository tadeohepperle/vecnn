import pandas as pd
import numpy as np

SISAP_TRUE_PATH = "../data/laion_gold_300k_(10000, 1000).bin"
CALC_TRUE_PATH = "../data/true_knn_300k_(10000, 1000).bin" # generated by compare.rs

def load_true_knns(path: str) -> np.ndarray:
    return np.fromfile(path, dtype=np.uint64).reshape((10000, 1000))

ds = load_true_knns(SISAP_TRUE_PATH)
dc = load_true_knns(CALC_TRUE_PATH)

# simple sanity check, that our calculated knns are rougly the same as the ones from sisap:
print(ds)
print(dc)
# a few neighbors are different in some rows, could be due to numerical inaccuracies

n_diff_rows = 0
avg_diff_neighbors = 0
print("Comparing the two knn sets:")
for r in range(10000):
    sorted_ds = np.sort(ds[r])
    sorted_dc = np.sort(dc[r])
    equal = np.equal(sorted_ds, sorted_dc)
    if not equal.all():
        n_diff_rows += 1
        set_ds_row = set(sorted_ds)
        set_dc_row = set(sorted_dc)
        in_ds_but_not_in_dc = set_ds_row.difference(set_dc_row)
        in_dc_but_not_in_ds = set_dc_row.difference(set_ds_row)
        n_diff = len(in_ds_but_not_in_dc)
        assert n_diff == len(in_dc_but_not_in_ds)
        avg_diff_neighbors += n_diff
        print(f"    Row {r} is not equal, {n_diff}/1000 neighbors are different!")
avg_diff_neighbors /= n_diff_rows
print(f"In total {n_diff_rows} rows ({n_diff_rows/10000*100}%) are different, with on average {avg_diff_neighbors:.2f} neighbors ({avg_diff_neighbors/1000*100:.2f}%) different per row.")

# probably not too big of a deal. Overall only 0.02% of the neighbors are different across all rows. 
# This is the output:
"""
In total 97 rows (0.97%) are different, with on average 21.68 neighbors (2.17%) different per row.
    Row 334 is not equal, 93/1000 neighbors are different!
    Row 360 is not equal, 1/1000 neighbors are different!
    Row 508 is not equal, 20/1000 neighbors are different!
    Row 509 is not equal, 14/1000 neighbors are different!
    Row 513 is not equal, 46/1000 neighbors are different!
    Row 574 is not equal, 9/1000 neighbors are different!
    Row 708 is not equal, 1/1000 neighbors are different!
    Row 905 is not equal, 5/1000 neighbors are different!
    Row 947 is not equal, 15/1000 neighbors are different!
    Row 1121 is not equal, 1/1000 neighbors are different!
    Row 1423 is not equal, 13/1000 neighbors are different!
    Row 1466 is not equal, 81/1000 neighbors are different!
    Row 1472 is not equal, 11/1000 neighbors are different!
    Row 1485 is not equal, 7/1000 neighbors are different!
    Row 1511 is not equal, 11/1000 neighbors are different!
    Row 1612 is not equal, 47/1000 neighbors are different!
    Row 1711 is not equal, 17/1000 neighbors are different!
    Row 1841 is not equal, 10/1000 neighbors are different!
    Row 2233 is not equal, 5/1000 neighbors are different!
    Row 2261 is not equal, 2/1000 neighbors are different!
    Row 2383 is not equal, 5/1000 neighbors are different!
    Row 2454 is not equal, 87/1000 neighbors are different!
    Row 2563 is not equal, 1/1000 neighbors are different!
    Row 2676 is not equal, 1/1000 neighbors are different!
    Row 2906 is not equal, 46/1000 neighbors are different!
    Row 2978 is not equal, 11/1000 neighbors are different!
    Row 3015 is not equal, 1/1000 neighbors are different!
    Row 3191 is not equal, 102/1000 neighbors are different!
    Row 3192 is not equal, 36/1000 neighbors are different!
    Row 3219 is not equal, 47/1000 neighbors are different!
    Row 3270 is not equal, 70/1000 neighbors are different!
    Row 3272 is not equal, 15/1000 neighbors are different!
    Row 3285 is not equal, 1/1000 neighbors are different!
    Row 3376 is not equal, 85/1000 neighbors are different!
    Row 3576 is not equal, 86/1000 neighbors are different!
    Row 3623 is not equal, 14/1000 neighbors are different!
    Row 3664 is not equal, 1/1000 neighbors are different!
    Row 3722 is not equal, 4/1000 neighbors are different!
    Row 3987 is not equal, 25/1000 neighbors are different!
    Row 4171 is not equal, 5/1000 neighbors are different!
    Row 4177 is not equal, 75/1000 neighbors are different!
    Row 4276 is not equal, 1/1000 neighbors are different!
    Row 4368 is not equal, 1/1000 neighbors are different!
    Row 4791 is not equal, 104/1000 neighbors are different!
    Row 4929 is not equal, 15/1000 neighbors are different!
    Row 4930 is not equal, 87/1000 neighbors are different!
    Row 4950 is not equal, 12/1000 neighbors are different!
    Row 5035 is not equal, 1/1000 neighbors are different!
    Row 5309 is not equal, 7/1000 neighbors are different!
    Row 5403 is not equal, 1/1000 neighbors are different!
    Row 5418 is not equal, 1/1000 neighbors are different!
    Row 5446 is not equal, 1/1000 neighbors are different!
    Row 5466 is not equal, 17/1000 neighbors are different!
    Row 5496 is not equal, 2/1000 neighbors are different!
    Row 5526 is not equal, 1/1000 neighbors are different!
    Row 5666 is not equal, 73/1000 neighbors are different!
    Row 5753 is not equal, 1/1000 neighbors are different!
    Row 6012 is not equal, 14/1000 neighbors are different!
    Row 6274 is not equal, 2/1000 neighbors are different!
    Row 6361 is not equal, 8/1000 neighbors are different!
    Row 6413 is not equal, 11/1000 neighbors are different!
    Row 6568 is not equal, 3/1000 neighbors are different!
    Row 6635 is not equal, 1/1000 neighbors are different!
    Row 6638 is not equal, 15/1000 neighbors are different!
    Row 6713 is not equal, 40/1000 neighbors are different!
    Row 6957 is not equal, 33/1000 neighbors are different!
    Row 7272 is not equal, 10/1000 neighbors are different!
    Row 7275 is not equal, 84/1000 neighbors are different!
    Row 7357 is not equal, 13/1000 neighbors are different!
    Row 7509 is not equal, 1/1000 neighbors are different!
    Row 7556 is not equal, 34/1000 neighbors are different!
    Row 7564 is not equal, 1/1000 neighbors are different!
    Row 7663 is not equal, 1/1000 neighbors are different!
    Row 7704 is not equal, 19/1000 neighbors are different!
    Row 7753 is not equal, 1/1000 neighbors are different!
    Row 7773 is not equal, 1/1000 neighbors are different!
    Row 7936 is not equal, 1/1000 neighbors are different!
    Row 8169 is not equal, 21/1000 neighbors are different!
    Row 8185 is not equal, 4/1000 neighbors are different!
    Row 8309 is not equal, 1/1000 neighbors are different!
    Row 8326 is not equal, 2/1000 neighbors are different!
    Row 8343 is not equal, 13/1000 neighbors are different!
    Row 8439 is not equal, 1/1000 neighbors are different!
    Row 8515 is not equal, 12/1000 neighbors are different!
    Row 8546 is not equal, 1/1000 neighbors are different!
    Row 8793 is not equal, 41/1000 neighbors are different!
    Row 8949 is not equal, 1/1000 neighbors are different!
    Row 8986 is not equal, 1/1000 neighbors are different!
    Row 9204 is not equal, 9/1000 neighbors are different!
    Row 9454 is not equal, 15/1000 neighbors are different!
    Row 9484 is not equal, 1/1000 neighbors are different!
    Row 9506 is not equal, 14/1000 neighbors are different!
    Row 9545 is not equal, 90/1000 neighbors are different!
    Row 9572 is not equal, 44/1000 neighbors are different!
    Row 9627 is not equal, 12/1000 neighbors are different!
    Row 9711 is not equal, 57/1000 neighbors are different!
    Row 9807 is not equal, 18/1000 neighbors are different!
"""